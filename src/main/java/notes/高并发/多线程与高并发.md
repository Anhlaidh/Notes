# Note
## 基本概念
### 进程 线程 纤程(quasar)
- Java线程,详见Java笔记
    - 补充,可以有lambda表达式写法
    - 三种启动线程方式
        1. Thread
        2. Runnable
        3. Executors.newCachedThread(本质也是调用上两个)
    - sleep ,睡眠多少秒,其他线程可以运行
    - yield,加入等待队列,有可能立马还是自己
    - join , 调用另一个线程,保证顺序
    - interrupt , 抛出异常,处理catch
- 锁
    - synchronized 
        - 可重入锁
        - synchronized(this) - > synchronized void m() ,static synchronized锁的是T.class
        -保证原子性和可见性 
        - 底层实现
            - 锁升级
                1. 偏向锁 标记线程
                2. 自旋锁 自旋十次 消耗cpu,用户态
                3. 重量级锁 - OS,os等待队列,不占cpu,但要跟os交互,内核态
                - 执行时间长,线程数多用系统锁
                - 执行时间段(加锁代码),线程数少,用自旋锁
        - 不能阻止指令重排序
    - Lock
    - 异常会释放锁
    - volatile(可变的)
        - 保证线程可见性
            - MESI
            - 缓存一致性协议
        - 禁止指令重排序
            - DCL单例
            - Double Check Lock
            - Mgr06.java 
            - loadfence原语指令
            - storefence原语指令
        - 不能保证原子性
    - dirty read
        - 锁写不锁读
    - 优化,粗化,细化
    - CAS(无锁优化 自选) compare and set/swap (乐观锁)
        - cas(V,Expected,NewValue)
          > if V==E   
            V=New otherwise try again or fail
        - cpu原语支持
        - ABA问题
            - 基础类型无所谓
            - 引用类型,女朋友符合,中间经历了别的...
           1. 不管
           2. 加版本号,检查版本号
        - Unsafe类=c c++指针
            - 直接操作内存
                - allocateMemory putXXX freeMemory pageSize
            - 直接生成实例
                - allocateInstance
            - 直接操作类或者实例变量
                - objectFiledOffset
                - getInt
                - getObject
            - CAS相关操作
                - weakCompareAndSetObject int Long   